# æ”¶é›†è¨Šæ¯

ä½ å•å¾—éå¸¸å¥½ï¼Œè€Œä¸”é€™æ­£æ˜¯ SLAM / `gmapping` æ‡‰ç”¨æ™‚æœ€å¸¸é‡åˆ°çš„é‡é»ä¹‹ä¸€ï¼

---

## âœ… å…ˆèªªã€Œè½‰æ›æ­æ‹‰è§’ç‚ºå››å…ƒæ•¸å»£æ’­ TFã€èƒ½åšä»€éº¼ï¼Ÿ

### â¤ ä¸»è¦ç”¨é€”ï¼š**å»ºç«‹æ­£ç¢ºçš„ TF Treeï¼ˆåº§æ¨™è½‰æ›é—œä¿‚ï¼‰**

ROS ä¸­ï¼Œ`tf` å°±æ˜¯ç”¨ä¾†æè¿°ã€Œèª°åœ¨å“ªå€‹æ¡†æ¶ä¸‹ã€ã€ã€Œå½¼æ­¤æ€éº¼ç§»å‹•ã€ï¼Œåƒæ˜¯ï¼š

```
map â†’ odom â†’ base_link â†’ imu_link

```

è€Œ IMU çµ¦ä½ çš„é€šå¸¸æ˜¯ **è§’åº¦ï¼ˆEulerï¼‰**ï¼Œä½† `tf2` å»£æ’­çš„æ˜¯ **å››å…ƒæ•¸ï¼ˆQuaternionï¼‰**ã€‚æ‰€ä»¥ä½ è¦ï¼š

ğŸ”„ å°‡è§’åº¦ï¼ˆroll, pitch, yawï¼‰ âœ å››å…ƒæ•¸ï¼ˆx, y, z, wï¼‰

é€™æ¨£ `tf2_ros.TransformBroadcaster` æ‰èƒ½æ­£ç¢ºä½¿ç”¨ã€‚

---

## âœ… å¦‚æœä½ è¦è®“ `gmapping` å¯ä»¥æ­£å¸¸é‹ä½œï¼Œä½ éœ€è¦çš„ **TF Tree è‡³å°‘åŒ…å«é€™äº›è½‰æ›**ï¼š

```
map â†’ odom â†’ base_link

```

è€Œä¸æ˜¯ IMU çš„ä½ç½®ã€‚

---

## ğŸ§­ æ­£ç¢ºçš„ tf çµæ§‹å»ºè­°å¦‚ä¸‹ï¼ˆgmapping å°ˆç”¨ï¼‰ï¼š

| ä¾†æº | child | å‚™è¨» |
| --- | --- | --- |
| `map` | `odom` | ç”± SLAM ä¼°è¨ˆå¾—å‡ºçš„ä½ç½® |
| `odom` | `base_link` | ç”± encodersã€IMU ç­‰è¨ˆç®— |
| `base_link` | `laser` (å¯é¸) | å¦‚æœä½ æœ‰é›·å°„æˆ– LIDAR |
| `base_link` | `imu_link` (å¯é¸) | å¦‚æœä½ è¦è¦–è¦ºåŒ– IMU è³‡æ–™ |

---

## âœ… ä½ å¯ä»¥é€™æ¨£è¨­å®šä½ çš„ TF å»£æ’­é †åºï¼š

### å¦‚æœä½ æœ‰ IMUï¼Œå¯ä»¥å»£æ’­ï¼š

```
base_link â†’ imu_link

```

é€™ä¸å½±éŸ¿ `gmapping` çš„å®šä½ï¼Œä½†å¯ç”¨æ–¼ï¼š

- rviz ä¸­é¡¯ç¤º IMU çš„å§¿æ…‹è®ŠåŒ–
- IMU è¼”åŠ©å°èˆªï¼ˆçµ¦ robot_localizationï¼‰

---

### å¦‚æœä½ è¦çµ¦ `gmapping` ä½¿ç”¨ï¼Œé‡é»æ˜¯ï¼š

1. **ç¢ºä¿é›·å°„åº§æ¨™çš„ TF æ˜¯æ­£ç¢ºçš„**
    
    ä½ éœ€è¦æœ‰ä¸€å€‹ç©©å®šçš„ï¼š
    
    ```
    base_link â†’ laser
    
    ```
    
    å› ç‚º `gmapping` ä¸»è¦ä¾è³´é›·å°„ã€‚
    
2. **ç¢ºä¿ odometry TF æ˜¯é€£è²«çš„**ï¼š
    
    ```
    map â†’ odom â†’ base_link
    
    ```
    
    `gmapping` æœƒè‡ªå‹•å»£æ’­ `map â†’ odom`ï¼Œä½ åªè¦æä¾› `odom â†’ base_link` å°±å¥½ï¼ˆé€šå¸¸æ˜¯ odometry node è² è²¬ï¼‰
    

---

## âœ… ä½ çš„ IMU å»£æ’­ tf å»ºè­°é•·é€™æ¨£ï¼š

```python
transform.header.frame_id = 'base_link'
transform.child_frame_id = 'imu_link'
transform.transform.translation.x = 0.0
transform.transform.translation.y = 0.0
transform.transform.translation.z = 0.0

# å°‡ Euler (roll, pitch, yaw) è½‰æ›ç‚º Quaternion
q = self.euler_to_quaternion(roll, pitch, yaw)
transform.transform.rotation.x = q[0]
transform.transform.rotation.y = q[1]
transform.transform.rotation.z = q[2]
transform.transform.rotation.w = q[3]

```

---

## ğŸ§­ Gmapping çš„æœ€å° TF éœ€æ±‚ï¼š

å¦‚æœä½ åªæƒ³è·‘ Gmappingï¼Œ**ä½ åªè¦æä¾›é€™æ¢ TF å°±å¤ äº†ï¼š**

```
odom â†’ base_link

```

ä½ å¯ä»¥ï¼š

- é€éæ©Ÿå™¨äººæ§åˆ¶å™¨ä¾†å»£æ’­ï¼ˆå¾ç·¨ç¢¼å™¨æ¨ç®— odomï¼‰
- æˆ–ç”¨ IMU/Encoder ç¶œåˆè¼¸å…¥ï¼ˆåƒ `robot_localization`ï¼‰

---

## 

å¤ªæ£’äº†ï¼ä½ é€™å€‹æƒ³æ³•éå¸¸å¯¦ç”¨ï¼Œè€Œä¸”æ–¹å‘æ­£ç¢º ğŸ‘

ä½ æ‰“ç®—**ç”¨ IMU + Lidarï¼ˆ/scanï¼‰**ä¾†è·‘ `gmapping`ï¼Œä¸¦å¸Œæœ›é€éï¼š

```
imu_link â†’ base_link
base_link â†’ laser

```

é€™æ¨£çš„ TF treeï¼Œè®“ `gmapping` èƒ½æ­£ç¢ºåœ°å®šä½èˆ‡å»ºåœ–ã€‚

---

## âœ… ä½ éœ€è¦çš„ TF Tree æ‡‰è©²é•·é€™æ¨£ï¼š

```
map
 â””â”€â”€ odom
      â””â”€â”€ base_link
           â”œâ”€â”€ imu_link   â† IMU æä¾›å§¿æ…‹
           â””â”€â”€ laser      â† Lidar ç™¼å‡º /scan

```

é€™æ¨£ `gmapping` æ‰èƒ½å¾ `/scan` è³‡æ–™çŸ¥é“é›·å°„åœ¨å“ªè£¡ï¼Œé€²è€Œå»ºåœ°åœ–ã€‚

---

## âœ… å¦‚ä½•åšåˆ°ï¼Ÿä½ åªè¦æä¾›å…©æ¢ TFï¼š

### 1ï¸âƒ£ `imu_link â†’ base_link`ï¼ˆä½ æœƒç”¨ IMU å»£æ’­é€™å€‹ TFï¼‰

- æŠŠ IMU çš„è§’åº¦è³‡è¨Šç”¨ä¾†è¨ˆç®—å››å…ƒæ•¸
- å»£æ’­é€™å€‹å§¿æ…‹è½‰æ›ï¼ˆè§’åº¦è³‡è¨Šï¼‰
- å¹³ç§»è¨­ç‚º 0ï¼ˆIMU è£åœ¨ base_link ä¸Šï¼‰

### 2ï¸âƒ£ `base_link â†’ laser`ï¼ˆç”¨ static transform publisher å›ºå®šï¼‰

å¦‚æœé›·å°„æ˜¯å›ºå®šåœ¨ base_link ä¸Šï¼Œç›´æ¥ç”¨ ROS å…§å»ºçš„éœæ…‹å»£æ’­å™¨ï¼š

```bash
ros2 run tf2_ros static_transform_publisher 0 0 0 0 0 0 base_link laser

```

ï¼ˆå¯æ ¹æ“šå¯¦éš›ä½ç½®è¨­ offsetï¼‰

---

## âœ… ä½ çš„ IMU TF å»£æ’­ç¨‹å¼è©²æ€éº¼æ”¹ï¼Ÿ

ä»¥ä¸‹æ˜¯ **å°‡ IMU è³‡æ–™è½‰ç‚ºå››å…ƒæ•¸ä¸¦å»£æ’­ TFï¼ˆimu_link â†’ base_linkï¼‰** çš„ç¯„ä¾‹ï¼š

```python
def euler_to_quaternion(self, roll, pitch, yaw):
    qx = math.sin(roll / 2) * math.cos(pitch / 2) * math.cos(yaw / 2) - math.cos(roll / 2) * math.sin(pitch / 2) * math.sin(yaw / 2)
    qy = math.cos(roll / 2) * math.sin(pitch / 2) * math.cos(yaw / 2) + math.sin(roll / 2) * math.cos(pitch / 2) * math.sin(yaw / 2)
    qz = math.cos(roll / 2) * math.cos(pitch / 2) * math.sin(yaw / 2) - math.sin(roll / 2) * math.sin(pitch / 2) * math.cos(yaw / 2)
    qw = math.cos(roll / 2) * math.cos(pitch / 2) * math.cos(yaw / 2) + math.sin(roll / 2) * math.sin(pitch / 2) * math.sin(yaw / 2)
    return [qx, qy, qz, qw]

def broadcast_imu_tf(self, roll_deg, pitch_deg, yaw_deg):
    roll = math.radians(roll_deg)
    pitch = math.radians(pitch_deg)
    yaw = math.radians(yaw_deg)

    q = self.euler_to_quaternion(roll, pitch, yaw)

    transform = TransformStamped()
    transform.header.stamp = self.get_clock().now().to_msg()
    transform.header.frame_id = 'imu_link'
    transform.child_frame_id = 'base_link'
    transform.transform.translation.x = 0.0
    transform.transform.translation.y = 0.0
    transform.transform.translation.z = 0.0
    transform.transform.rotation.x = q[0]
    transform.transform.rotation.y = q[1]
    transform.transform.rotation.z = q[2]
    transform.transform.rotation.w = q[3]
    self.tf_broadcaster.sendTransform(transform)

```

ç„¶å¾Œåœ¨ callback ä¸­åŠ å…¥ï¼š

```python
self.broadcast_imu_tf(self.imudata.Angle[0], self.imudata.Angle[1], self.imudata.Angle[2])

```

---

## âœ… æœ€å¾Œä½ åªéœ€è¦åšåˆ°ä»¥ä¸‹ä¸‰ä»¶äº‹å°±èƒ½è·‘ Gmappingï¼š

| é …ç›® | èªªæ˜ |
| --- | --- |
| âœ… `/scan` | ç”±é›·å°„è³‡æ–™ç™¼å‡º |
| âœ… `/tf` | å»£æ’­æ­£ç¢ºçš„ TF treeï¼Œè‡³å°‘åŒ…å« `odom â†’ base_link â†’ laser` |
| âœ… `gmapping` | åŸ·è¡Œ `ros2 launch` æˆ– `ros2 run slam_toolbox` or `gmapping` å¥—ä»¶ |

---

## âœ… é¡å¤–å»ºè­°

è‹¥ä½ æœªä¾†è¦åŠ å…¥ **odom**ï¼ˆè¼ªå­è½‰é€Ÿæˆ– `robot_localization`ï¼‰ï¼Œä½ å°±å¯ä»¥æä¾›ï¼š

```
odom â†’ base_link

```

å†è®“ Gmapping è‡ªå‹•ç”¢ç”Ÿï¼š

```
map â†’ odom

```

ä½ æ•´å€‹ TF tree å°±å®Œæˆäº†ï¼

---

éœ€è¦æˆ‘å¹«ä½ ç•«å‡º TF tree åœ–ç¤ºï¼Œæˆ–å¯«å¥½ launch æª”è®“ä½ è·‘ `gmapping` å—ï¼Ÿé‚„æ˜¯ä½ æƒ³æˆ‘å¹«ä½ æ•´åˆ `imu_node + tf_broadcaster + static transform` æˆä¸€å€‹å®Œæ•´æ–¹æ¡ˆï¼Ÿ